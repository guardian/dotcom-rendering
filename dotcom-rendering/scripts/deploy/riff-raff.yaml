stacks: [frontend]
regions: [eu-west-1]
allowedStages:
  - CODE
  - PROD
templates:
  cloudformation:
    type: cloud-formation
    parameters:
      amiEncrypted: true
      amiTags:
        # Keep the Node version in sync with `.nvmrc`
        Recipe: dotcom-rendering-ARM-jammy-node-18.18.2-cdk-base
        AmigoStage: PROD
deployments:
  frontend-static:
    type: aws-s3
    parameters:
      bucketSsmKey: /account/services/dotcom-static.bucket
      cacheControl:
        - pattern: \/stats\/ # stats file can change on each deploy
          value: max-age=3600 # one hour in seconds
          # assume all other assets are hashed and never change,
          # even though this is not the caseâ€“e.g. icons
        - pattern: .*
          value: public, max-age=315360000, immutable # one year in seconds
      prefixStack: false
      publicReadAcl: false
  # rendering cloudformation
  rendering-cfn:
    template: cloudformation
    parameters:
      templateStagePaths:
        CODE: DotcomRendering-CODE.template.json
        PROD: DotcomRendering-PROD.template.json
      cloudFormationStackByTags: false
      cloudFormationStackName: rendering
      amiParameter: AMIRendering
  # rendering autoscaling
  rendering:
    type: autoscaling
    parameters:
      bucketSsmKey: /account/services/dotcom-artifact.bucket
      # Default is 900 (15 mins), this is 25 mins
      secondsToWait: 1500
    dependencies:
      - frontend-static
      - rendering-cfn
  # article-rendering cloudformation
  article-rendering-cfn:
    template: cloudformation
    parameters:
      templateStagePaths:
        CODE: ArticleRendering-CODE.template.json
        PROD: ArticleRendering-PROD.template.json
      cloudFormationStackByTags: false
      cloudFormationStackName: article-rendering
      amiParameter: AMIArticlerendering
  # article-rendering autoscaling
  article-rendering:
    type: autoscaling
    parameters:
      bucketSsmKey: /account/services/dotcom-artifact.bucket
      # Default is 900 (15 mins), this is 25 mins
      secondsToWait: 1500
    dependencies:
      - frontend-static
      - article-rendering-cfn
  # To be implemented:
  # - facia-rendering
  # - misc-rendering
  # - interactive-rendering
